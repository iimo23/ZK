{% extends 'base.html' %}

{% block title %}Users - ZK Device Management{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Device Users</h5>
                <div>
                    <button class="btn btn-sm btn-outline-primary" id="refreshBtn">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="usersContainer">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading users...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Notification function
    function showNotification(message, type = 'success') {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
        alertDiv.style.zIndex = 1050;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        document.body.appendChild(alertDiv);
        
        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            alertDiv.classList.remove('show');
            setTimeout(() => alertDiv.remove(), 150);
        }, 5000);
    }

    // Load users
    async function loadUsers() {
        const usersContainer = document.getElementById('usersContainer');
        
        try {
            usersContainer.innerHTML = `
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading users...</p>
                </div>
            `;
            
            const response = await fetch('/api/users');
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.message) {
                usersContainer.innerHTML = `
                    <div class="alert alert-warning">
                        ${data.message}
                    </div>
                `;
                return;
            }
            
            if (!data.length) {
                usersContainer.innerHTML = `
                    <div class="alert alert-info">
                        No users found on the device.
                    </div>
                `;
                return;
            }
            
            // Create users table
            let html = `
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>User ID</th>
                                <th>Name</th>
                                <th>Privilege</th>
                                <th>Card</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Map privilege levels to readable names
            const privilegeMap = {
                0: 'User',
                1: 'Enroller',
                2: 'Admin',
                3: 'Super Admin',
                14: 'Super Admin'
            };
            
            for (const user of data) {
                html += `
                    <tr>
                        <td>${user.user_id}</td>
                        <td>${user.name || 'N/A'}</td>
                        <td>${privilegeMap[user.privilege] || user.privilege}</td>
                        <td>${user.card || 'N/A'}</td>
                    </tr>
                `;
            }
            
            html += `
                        </tbody>
                    </table>
                </div>
                <p class="text-muted mt-2">Total users: ${data.length}</p>
            `;
            
            usersContainer.innerHTML = html;
            
        } catch (error) {
            console.error('Error loading users:', error);
            usersContainer.innerHTML = `
                <div class="alert alert-danger">
                    Error loading users: ${error.message}
                </div>
            `;
        }
    }
    
    // Event listeners
    document.addEventListener('DOMContentLoaded', () => {
        loadUsers();
        
        document.getElementById('refreshBtn').addEventListener('click', loadUsers);
    });
</script>
{% endblock %}
