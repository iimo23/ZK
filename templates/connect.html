{% extends "base.html" %}

{% block title %}Connect Device - ZK Attendance System{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="h3 mb-0">Connect to Device</h1>
        <p class="text-muted">Connect to your ZK biometric device</p>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-8 mx-auto">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Select Device</h5>
            </div>
            <div class="card-body">
                <div id="device-selection">
                    <div class="text-center py-3" id="loading-devices">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading devices...</p>
                    </div>
                    <div id="no-devices-message" class="text-center py-3 d-none">
                        <p>No devices registered. Please connect to a new device below.</p>
                    </div>
                    <div id="device-list" class="d-none">
                        <p>Select a device to connect to:</p>
                        <div class="list-group mb-3" id="device-list-group">
                            <!-- Devices will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8 mx-auto">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Connect to New Device</h5>
            </div>
            <div class="card-body">
                <form id="connect-form" method="POST" action="{{ url_for('connect') }}">
                    <div class="mb-3">
                        <label for="device_ip" class="form-label">Device IP Address</label>
                        <input type="text" class="form-control" id="device_ip" name="device_ip" 
                               value="{{ session.get('device_ip', '') }}" required>
                        <div class="form-text">Enter the IP address of your ZK biometric device</div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="device_port" class="form-label">Port</label>
                            <input type="number" class="form-control" id="device_port" name="device_port" 
                                   value="{{ session.get('device_port', '4370') }}" required>
                            <div class="form-text">Default port is 4370</div>
                        </div>
                        <div class="col-md-6">
                            <label for="timeout" class="form-label">Timeout (seconds)</label>
                            <input type="number" class="form-control" id="timeout" name="timeout" 
                                   value="{{ session.get('timeout', '5') }}" required>
                            <div class="form-text">Connection timeout in seconds</div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-plug"></i> Connect
                        </button>
                        {% if session.get('device_ip') %}
                        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Back to Dashboard
                        </a>
                        {% endif %}
                    </div>
                </form>
                
                <div id="connection-status" class="mt-4 d-none">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border text-primary me-3" role="status">
                            <span class="visually-hidden">Connecting...</span>
                        </div>
                        <div>
                            <h5 class="mb-1">Connecting to device...</h5>
                            <p class="mb-0 text-muted">This may take a few moments</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // DOM elements
        const connectForm = document.getElementById('connect-form');
        const connectionStatus = document.getElementById('connection-status');
        const loadingDevices = document.getElementById('loading-devices');
        const noDevicesMessage = document.getElementById('no-devices-message');
        const deviceList = document.getElementById('device-list');
        const deviceListGroup = document.getElementById('device-list-group');
        
        // Load devices on page load
        loadDevices();
        
        // Connect form submission handler
        if (connectForm) {
            connectForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                // Show connection status
                connectionStatus.classList.remove('d-none');
                
                // Get form data
                const formData = new FormData(connectForm);
                const data = {
                    device_ip: formData.get('device_ip'),
                    device_port: formData.get('device_port'),
                    timeout: formData.get('timeout')
                };
                
                // Generate a device ID and name based on IP
                const deviceId = 'device_' + Date.now();
                const deviceName = 'Device at ' + data.device_ip;
                
                // Add device data
                const deviceData = {
                    device_id: deviceId,
                    name: deviceName,
                    ip: data.device_ip,
                    port: parseInt(data.device_port),
                    timeout: parseInt(data.timeout)
                };
                
                try {
                    // Add device to manager
                    const addResponse = await fetch('/api/devices', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(deviceData)
                    });
                    
                    const addResult = await addResponse.json();
                    
                    if (addResult.status === 'success' || addResult.status === 'warning') {
                        // Show success message
                        const alertHtml = `
                            <div class="alert alert-${addResult.status === 'success' ? 'success' : 'warning'} alert-dismissible fade show mt-3" role="alert">
                                <strong>${addResult.status === 'success' ? 'Success!' : 'Warning!'}</strong> ${addResult.message}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        `;
                        connectionStatus.insertAdjacentHTML('afterend', alertHtml);
                        
                        // Redirect to dashboard after a short delay
                        setTimeout(() => {
                            window.location.href = '/';
                        }, 1500);
                    } else {
                        // Show error message
                        const alertHtml = `
                            <div class="alert alert-danger alert-dismissible fade show mt-3" role="alert">
                                <strong>Error!</strong> ${addResult.message || 'Failed to connect to device.'}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        `;
                        connectionStatus.insertAdjacentHTML('afterend', alertHtml);
                        connectionStatus.classList.add('d-none');
                    }
                } catch (error) {
                    // Show error message
                    const alertHtml = `
                        <div class="alert alert-danger alert-dismissible fade show mt-3" role="alert">
                            <strong>Error!</strong> ${error.message || 'Failed to connect to device.'}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    `;
                    connectionStatus.insertAdjacentHTML('afterend', alertHtml);
                    connectionStatus.classList.add('d-none');
                }
            });
        }
        
        // Function to load devices
        async function loadDevices() {
            try {
                const response = await fetch('/api/devices');
                const data = await response.json();
                
                // Hide loading spinner
                loadingDevices.classList.add('d-none');
                
                if (data.status === 'success') {
                    const devices = data.devices;
                    
                    if (devices && Object.keys(devices).length > 0) {
                        // Show device list
                        deviceList.classList.remove('d-none');
                        
                        // Clear existing items
                        deviceListGroup.innerHTML = '';
                        
                        // Add items for each device
                        Object.entries(devices).forEach(([deviceId, device]) => {
                            const item = document.createElement('a');
                            item.href = '#';
                            item.className = 'list-group-item list-group-item-action';
                            item.dataset.deviceId = deviceId;
                            
                            // Format last connected date
                            let lastConnected = 'Never';
                            if (device.last_connected) {
                                const date = new Date(device.last_connected);
                                lastConnected = date.toLocaleString();
                            }
                            
                            item.innerHTML = `
                                <div class="d-flex w-100 justify-content-between">
                                    <h5 class="mb-1">${device.name}</h5>
                                    <small class="device-status-${deviceId}">
                                        <span class="spinner-border spinner-border-sm" role="status"></span>
                                        Checking...
                                    </small>
                                </div>
                                <p class="mb-1">${device.ip}:${device.port}</p>
                                <small>Last connected: ${lastConnected}</small>
                            `;
                            
                            deviceListGroup.appendChild(item);
                            
                            // Check device status
                            checkDeviceStatus(deviceId);
                            
                            // Add click event to connect to this device
                            item.addEventListener('click', (e) => {
                                e.preventDefault();
                                connectToDevice(deviceId);
                            });
                        });
                    } else {
                        // Show no devices message
                        noDevicesMessage.classList.remove('d-none');
                    }
                } else {
                    // Show error
                    noDevicesMessage.classList.remove('d-none');
                    noDevicesMessage.innerHTML = `<p class="text-danger">Error loading devices: ${data.message || 'Unknown error'}</p>`;
                }
            } catch (error) {
                // Show error
                loadingDevices.classList.add('d-none');
                noDevicesMessage.classList.remove('d-none');
                noDevicesMessage.innerHTML = `<p class="text-danger">Error loading devices: ${error.message}</p>`;
            }
        }
        
        // Function to check device connection status
        async function checkDeviceStatus(deviceId) {
            const statusElement = document.querySelector(`.device-status-${deviceId}`);
            
            try {
                const response = await fetch(`/api/devices/${deviceId}/test-connection`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.status === 'success') {
                    statusElement.innerHTML = '<span class="badge bg-success">Connected</span>';
                } else {
                    statusElement.innerHTML = '<span class="badge bg-danger">Disconnected</span>';
                }
            } catch (error) {
                statusElement.innerHTML = '<span class="badge bg-danger">Error</span>';
            }
        }
        
        // Function to connect to a device
        async function connectToDevice(deviceId) {
            try {
                // Show connection status
                connectionStatus.classList.remove('d-none');
                
                // First test the connection to make sure it works
                const testResponse = await fetch(`/api/devices/${deviceId}/test-connection`, {
                    method: 'POST'
                });
                
                const testResult = await testResponse.json();
                
                if (testResult.status === 'success') {
                    // If connection test is successful, set as active device
                    const response = await fetch(`/api/devices/${deviceId}/set-active`, {
                        method: 'POST'
                    });
                    
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        // Show success message
                        const alertHtml = `
                            <div class="alert alert-success alert-dismissible fade show mt-3" role="alert">
                                <strong>Success!</strong> Device connected and set as active. This selection will be remembered.
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        `;
                        connectionStatus.insertAdjacentHTML('afterend', alertHtml);
                        
                        // Redirect to dashboard after a short delay
                        setTimeout(() => {
                            window.location.href = '/';
                        }, 1500);
                    } else {
                        // Show error message
                        const alertHtml = `
                            <div class="alert alert-danger alert-dismissible fade show mt-3" role="alert">
                                <strong>Error!</strong> ${result.message || 'Failed to set device as active.'}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        `;
                        connectionStatus.insertAdjacentHTML('afterend', alertHtml);
                        connectionStatus.classList.add('d-none');
                    }
                } else {
                    // Show error message
                    const alertHtml = `
                        <div class="alert alert-danger alert-dismissible fade show mt-3" role="alert">
                            <strong>Error!</strong> ${testResult.message || 'Failed to connect to device.'}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    `;
                    connectionStatus.insertAdjacentHTML('afterend', alertHtml);
                    connectionStatus.classList.add('d-none');
                }
            } catch (error) {
                // Show error message
                const alertHtml = `
                    <div class="alert alert-danger alert-dismissible fade show mt-3" role="alert">
                        <strong>Error!</strong> ${error.message || 'Failed to connect to device.'}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                `;
                connectionStatus.insertAdjacentHTML('afterend', alertHtml);
                connectionStatus.classList.add('d-none');
            }
        }
    });
</script>
{% endblock %}
