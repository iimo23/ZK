{% extends "base.html" %}

{% block title %}إرسال بيانات الحضور - نظام الحضور ZK{% endblock %}

{% block content %}
{% if last_send_info %}
<div class="alert alert-info mb-4">
    <strong>آخر إرسال ناجح:</strong><br>
    <span><i class="bi bi-calendar-check"></i> {{ last_send_info.last_send_time|default('غير متوفر') }}</span><br>
    <span><i class="bi bi-info-circle"></i> {{ last_send_info.last_send_data.summary|default('غير متوفر') }}</span>
</div>
{% endif %}

<div class="row mb-4">
    <div class="col-12">
        <h1 class="h3 mb-0">إرسال بيانات الحضور</h1>
        <p class="text-muted">إرسال سجلات الحضور إلى SAS   </p>
    </div>
</div>

{% if last_send_info %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow-sm border-success">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-lightning-charge"></i> مزامنة</h5>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h6 class="text-success">إرسال السجلات الجديدة منذ آخر إرسال ناجح</h6>
                        <p class="mb-0">
                            <strong>من:</strong> {{ last_send_info.last_send_time.split(' ')[0] if last_send_info.last_send_time else 'غير متوفر' }}<br>
                            <strong>إلى:</strong> اليوم ({{ now.strftime('%Y-%m-%d') }})
                        </p>
                    </div>
                    <div class="col-md-4 text-end">
                        <button id="quick-send-btn" class="btn btn-success btn-lg">
                            <i class="bi bi-lightning-charge"></i> مزامنة    
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}


<!-- Device connection status will be checked via JavaScript -->
<div class="row mb-4" id="no-device-warning" style="display: none;">
    <div class="col-12">
        <div class="alert alert-warning shadow-sm">
            <div class="d-flex align-items-center">
                <div class="flex-shrink-0">
                    <i class="bi bi-exclamation-triangle-fill fs-3 me-3"></i>
                </div>
                <div class="flex-grow-1">
                    <h5 class="alert-heading">لا يوجد جهاز متصل</h5>
                    <p class="mb-0">تحتاج إلى الاتصال بجهاز أولاً قبل إرسال البيانات.</p>
                </div>
                <div class="flex-shrink-0">
                    <a href="{{ url_for('connect') }}" class="btn btn-warning">
                        <i class="bi bi-plug"></i> توصيل الجهاز
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="date-range-form-container">
<div class="row">
    <div class="col-md-12">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">اختيار نطاق التاريخ</h5>
            </div>
            <div class="card-body">
                <form id="date-range-form" class="row g-3">
                    <div class="col-md-5">
                        <label for="start_date" class="form-label">تاريخ البداية</label>
                        <input type="date" class="form-control" id="start_date" name="start_date" required>
                    </div>
                    <div class="col-md-5">
                        <label for="end_date" class="form-label">تاريخ النهاية</label>
                        <input type="date" class="form-control" id="end_date" name="end_date" required>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-search"></i> معاينة
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Data Preview -->
        <div id="data-preview" class="card shadow-sm mb-4 d-none">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">معاينة البيانات</h5>
                <span id="record-count" class="badge bg-light text-dark">0 سجل</span>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>رقم المستخدم</th>
                                <th>الاسم</th>
                                <th>التاريخ والوقت</th>
                                <th>نوع التسجيل</th>
                            </tr>
                        </thead>
                        <tbody id="preview-table">
                            <!-- Preview data will be loaded here -->
                        </tbody>
                    </table>
                </div>
                
                <div id="preview-loading" class="text-center py-3 d-none">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">جاري التحميل...</span>
                    </div>
                    <p class="mt-2">جاري تحميل بيانات الحضور...</p>
                </div>
                
                <div id="no-records" class="text-center py-3 d-none">
                    <i class="bi bi-exclamation-circle text-warning fs-1"></i>
                    <p class="mt-2">لم يتم العثور على سجلات حضور للنطاق الزمني المحدد.</p>
                </div>
                
                <div class="mt-3">
                    <button id="send-to-api" class="btn btn-success" disabled>
                        <i class="bi bi-cloud-upload"></i>مزامنة إلى SAS
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Send Status -->
        <div id="send-status" class="card shadow-sm d-none">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">حالة الإرسال</h5>
            </div>
            <div class="card-body" id="send-status-content">
                <!-- سيتم عرض حالة الإرسال هنا -->
            </div>
        </div>
    </div>
</div>
</div><!-- End of date-range-form-container -->
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Check if a device is connected using the device manager
        const checkDeviceConnection = async () => {
            try {
                const response = await fetch('/api/devices');
                const data = await response.json();
                
                if (data.status === 'success') {
                    // Check if there are any registered devices
                    if (Object.keys(data.devices).length === 0) {
                        document.getElementById('no-device-warning').style.display = 'block';
                        document.getElementById('date-range-form-container').style.display = 'none';
                        return false;
                    }
                    
                    // Check if there is an active device
                    if (!data.active_device) {
                        document.getElementById('no-device-warning').style.display = 'block';
                        document.getElementById('date-range-form-container').style.display = 'none';
                        return false;
                    }
                    
                    // Device is connected
                    document.getElementById('no-device-warning').style.display = 'none';
                    document.getElementById('date-range-form-container').style.display = 'block';
                    return true;
                } else {
                    // API error
                    document.getElementById('no-device-warning').style.display = 'block';
                    document.getElementById('date-range-form-container').style.display = 'none';
                    return false;
                }
            } catch (error) {
                console.error('Error checking device connection:', error);
                document.getElementById('no-device-warning').style.display = 'block';
                document.getElementById('date-range-form-container').style.display = 'none';
                return false;
            }
        };
        
        // Check device connection on page load
        checkDeviceConnection();
        
        const dateRangeForm = document.getElementById('date-range-form');
        const dataPreview = document.getElementById('data-preview');
        const previewTable = document.getElementById('preview-table');
        const previewLoading = document.getElementById('preview-loading');
        const noRecords = document.getElementById('no-records');
        const recordCount = document.getElementById('record-count');
        const sendToApiBtn = document.getElementById('send-to-api');
        const sendStatus = document.getElementById('send-status');
        const sendStatusContent = document.getElementById('send-status-content');
        
        // API URL Configuration Elements
        const currentApiUrl = document.getElementById('current-api-url');
        const editApiUrlBtn = document.getElementById('edit-api-url-btn');
        const apiUrlDisplay = document.getElementById('api-url-display');
        const apiUrlEdit = document.getElementById('api-url-edit');
        const apiUrlForm = document.getElementById('api-url-form');
        const apiUrlInput = document.getElementById('api_url');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const apiUrlStatus = document.getElementById('api-url-status');
        
        // Get today's date
        const today = new Date();
        
        // Format dates as YYYY-MM-DD
        const formatDate = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        
        // Try to get last successful send date from the page
        let lastSendDate = null;
        // Check if last_send_info exists and has a last_send_time
        const lastSendTimeStr = "{% if last_send_info and last_send_info.last_send_time %}{{ last_send_info.last_send_time }}{% endif %}";
        
        if (lastSendTimeStr) {
            try {
                // Parse the last send time (format: YYYY-MM-DD HH:MM:SS)
                const lastSendTimeParts = lastSendTimeStr.split(' ')[0].split('-');
                if (lastSendTimeParts.length === 3) {
                    lastSendDate = new Date(
                        parseInt(lastSendTimeParts[0]), 
                        parseInt(lastSendTimeParts[1]) - 1, // Month is 0-indexed in JS
                        parseInt(lastSendTimeParts[2])
                    );
                }
            } catch (e) {
                console.error('Error parsing last send date:', e);
            }
        }
        
        // If we couldn't get a valid last send date, default to yesterday
        if (!lastSendDate) {
            lastSendDate = new Date();
            lastSendDate.setDate(today.getDate() - 1);
        }
        
        // Set default date values
        if (document.getElementById('start_date')) {
            document.getElementById('start_date').value = formatDate(lastSendDate);
        }
        
        if (document.getElementById('end_date')) {
            document.getElementById('end_date').value = formatDate(today);
        }
        
        // Store the current records
        let currentRecords = [];
        
        // Handle quick send button click
        const quickSendBtn = document.getElementById('quick-send-btn');
        if (quickSendBtn) {
            quickSendBtn.addEventListener('click', async () => {
                // Get the date values from the form
                const startDate = document.getElementById('start_date').value;
                const endDate = document.getElementById('end_date').value;
                
                // Show send status
                sendStatus.classList.remove('d-none');
                sendStatusContent.innerHTML = `
                    <div class="alert alert-info">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm me-2" role="status">
                                <span class="visually-hidden">Sending...</span>
                            </div>
                            <div>Sending records from ${startDate} to ${endDate}...</div>
                        </div>
                    </div>
                `;
                
                // Disable quick send button
                quickSendBtn.disabled = true;
                
                try {
                    // Send data to API
                    const response = await fetch('/api/send-attendance', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            start_date: startDate,
                            end_date: endDate
                        })
                    });
                    
                    const result = await response.json();
                    
                    // Show result
                    if (result.status === 'success') {
                        // The last send time is already updated in the backend when the send is successful
                        // We just need to update the UI to reflect the changes
                        
                        // Format the current date in YYYY-MM-DD format
                        const now = new Date();
                        const currentDate = now.getFullYear() + '-' + 
                            String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                            String(now.getDate()).padStart(2, '0');
                        const summary = `Sent ${result.records_sent || 0} records from ${startDate} to ${endDate}`;
                        
                        // Update the last send info on the page
                        const lastSendInfoElement = document.querySelector('.alert.alert-info');
                        if (lastSendInfoElement) {
                            
                            lastSendInfoElement.innerHTML = `
                                <strong>Last Successful Send:</strong><br>
                                <span><i class="bi bi-calendar-check"></i> ${currentDate}</span><br>
                                <span><i class="bi bi-info-circle"></i> ${summary}</span>
                            `;
                            
                            // Also update the form's start date to today's date for next time
                            // This helps prepare for the next send operation
                            if (document.getElementById('start_date')) {
                                document.getElementById('start_date').value = formatDate(new Date());
                            }
                        }
                        
                        sendStatusContent.innerHTML = `
                            <div class="alert alert-success">
                                <h5><i class="bi bi-check-circle-fill me-2"></i> Success!</h5>
                                <p>تم إرسال ${result.records_sent || 0} سجلات إلى SAS.</p>
                                <p>تاريخ الإرسال الأخير تم تحديثه إلى: ${currentDate}</p>
                                <p class="mb-0"><strong>API Response:</strong> ${result.message || 'Data received successfully.'}</p>
                            </div>
                        `;
                        
                        // No need to reload the page as we've updated the UI already
                        // setTimeout(() => {
                        //     window.location.reload();
                        // }, 2000);
                    } else {
                        sendStatusContent.innerHTML = `
                            <div class="alert alert-danger">
                                <h5><i class="bi bi-x-circle-fill me-2"></i> Error!</h5>
                                <p>Failed to send data to API.</p>
                                <p class="mb-0"><strong>Error:</strong> ${result.message || 'Unknown error occurred.'}</p>
                            </div>
                        `;
                    }
                } catch (error) {
                    // Show error
                    sendStatusContent.innerHTML = `
                        <div class="alert alert-danger">
                            <h5><i class="bi bi-x-circle-fill me-2"></i> Error!</h5>
                            <p>Failed to send data to API.</p>
                            <p class="mb-0"><strong>Error:</strong> ${error.message}</p>
                        </div>
                    `;
                } finally {
                    // Re-enable quick send button
                    quickSendBtn.disabled = false;
                }
            });
        }
        
        // Load current API URL
        const loadApiUrl = async () => {
            try {
                const response = await fetch('/api/export-config');
                const data = await response.json();
                
                if (data.status === 'success' && data.config) {
                    const apiUrl = data.config.attendance_api_url || '';
                    currentApiUrl.textContent = apiUrl || 'Not configured';
                    if (apiUrlInput) {
                        apiUrlInput.value = apiUrl;
                    }
                } else {
                    currentApiUrl.textContent = 'Error loading configuration';
                }
            } catch (error) {
                currentApiUrl.textContent = `Error: ${error.message}`;
            }
        };
        
        // Load API URL on page load
        loadApiUrl();
        
        // Handle edit button click
        if (editApiUrlBtn) {
            editApiUrlBtn.addEventListener('click', () => {
                apiUrlDisplay.classList.add('d-none');
                apiUrlEdit.classList.remove('d-none');
            });
        }
        
        // Handle cancel button click
        if (cancelEditBtn) {
            cancelEditBtn.addEventListener('click', () => {
                apiUrlDisplay.classList.remove('d-none');
                apiUrlEdit.classList.add('d-none');
                apiUrlStatus.classList.add('d-none');
            });
        }
        
        // Handle API URL form submission
        if (apiUrlForm) {
            apiUrlForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const apiUrl = apiUrlInput.value.trim();
                
                // Show loading status
                apiUrlStatus.innerHTML = `
                    <div class="alert alert-info">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm me-2" role="status">
                                <span class="visually-hidden">Saving...</span>
                            </div>
                            <div>Saving API URL configuration...</div>
                        </div>
                    </div>
                `;
                apiUrlStatus.classList.remove('d-none');
                
                try {
                    // Send API URL to server
                    const response = await fetch('/api/export-config', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            attendance_api_url: apiUrl
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        // Show success message
                        apiUrlStatus.innerHTML = `
                            <div class="alert alert-success">
                                <div class="d-flex align-items-center">
                                    <div class="me-2">
                                        <i class="bi bi-check-circle-fill"></i>
                                    </div>
                                    <div>
                                        <strong>Success!</strong><br>
                                        API URL has been updated in both configuration files.
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        // Update displayed URL
                        currentApiUrl.textContent = apiUrl;
                        
                        // Switch back to display mode after a delay
                        setTimeout(() => {
                            apiUrlDisplay.classList.remove('d-none');
                            apiUrlEdit.classList.add('d-none');
                            apiUrlStatus.classList.add('d-none');
                        }, 2000);
                    } else {
                        // Show error message
                        apiUrlStatus.innerHTML = `
                            <div class="alert alert-danger">
                                <div class="d-flex align-items-center">
                                    <div class="me-2">
                                        <i class="bi bi-exclamation-triangle-fill"></i>
                                    </div>
                                    <div>
                                        <strong>Error</strong><br>
                                        ${result.message || 'Failed to update API URL.'}
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                } catch (error) {
                    // Show error message
                    apiUrlStatus.innerHTML = `
                        <div class="alert alert-danger">
                            <div class="d-flex align-items-center">
                                <div class="me-2">
                                    <i class="bi bi-exclamation-triangle-fill"></i>
                                </div>
                                <div>
                                    <strong>Error</strong><br>
                                    ${error.message || 'An error occurred during the update.'}
                                </div>
                            </div>
                        </div>
                    `;
                }
            });
        }
        
        // Preview data based on date range
        if (dateRangeForm) {
            dateRangeForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                // Get date range
                const startDate = document.getElementById('start_date').value;
                const endDate = document.getElementById('end_date').value;
                
                // Show loading
                dataPreview.classList.remove('d-none');
                previewLoading.classList.remove('d-none');
                noRecords.classList.add('d-none');
                previewTable.innerHTML = '';
                sendToApiBtn.disabled = true;
                
                try {
                    // Fetch attendance data
                    const response = await fetch(`/api/attendance?start_date=${startDate}&end_date=${endDate}`);
                    const data = await response.json();
                    
                    // Hide loading
                    previewLoading.classList.add('d-none');
                    
                    if (data.status === 'success' && data.attendance && data.attendance.length > 0) {
                        // Store records
                        currentRecords = data.attendance;
                        
                        // Update record count
                        recordCount.textContent = `${currentRecords.length} records`;
                        
                        // Sort records by timestamp (newest first)
                        const sortedRecords = [...currentRecords].sort((a, b) => {
                            return new Date(b.timestamp) - new Date(a.timestamp);
                        });
                        
                        // Debug: Log the first record to understand its structure
                        if (sortedRecords.length > 0) {
                            console.log('Record structure:', sortedRecords[0]);
                            console.log('Record properties:');
                            for (const key in sortedRecords[0]) {
                                console.log(`${key}: ${sortedRecords[0][key]}`);
                            }
                        }
                        
                        // Fetch user details to get names
                        fetch('/api/users')
                            .then(response => response.json())
                            .then(data => {
                                if (data.status === 'success') {
                                    // Create a map of user IDs to names
                                    window.userMap = {};
                                    data.users.forEach(user => {
                                        const userId = user.id || user.user_id || user.uid || '';
                                        if (userId) {
                                            window.userMap[userId] = user.name || 'Unknown';
                                        }
                                    });
                                    
                                    console.log('User map:', window.userMap);
                                    
                                    // After we have the user map, update the names in the table
                                    document.querySelectorAll('#preview-table tr').forEach(row => {
                                        const userId = row.getAttribute('data-user-id');
                                        if (userId && window.userMap[userId]) {
                                            const nameCell = row.querySelector('td:nth-child(2)');
                                            if (nameCell) {
                                                nameCell.textContent = window.userMap[userId];
                                            }
                                        }
                                    });
                                }
                            })
                            .catch(error => console.error('Error fetching users:', error));
                            
                        // Create a function to determine punch type based on the record data
                        function determinePunchType(record) {
                            console.log('Determining punch type for record:', record);
                            
                            // Check all possible properties for punch type
                            const punchValue = record.punch !== undefined ? record.punch : 
                                              record.status !== undefined ? record.status : 
                                              record.type !== undefined ? record.type : 
                                              record.punch_type !== undefined ? record.punch_type : null;
                            
                            console.log('Found punch value:', punchValue, 'type:', typeof punchValue);
                            
                            let badgeClass = 'bg-secondary';
                            let punchText = 'Unknown';
                            
                            // First try to use the value directly if it's a string
                            if (typeof punchValue === 'string' && punchValue.trim() !== '') {
                                const lowerPunch = punchValue.toLowerCase();
                                if (lowerPunch.includes('in')) {
                                    badgeClass = 'bg-success';
                                    punchText = 'Check In';
                                } else if (lowerPunch.includes('out')) {
                                    badgeClass = 'bg-danger';
                                    punchText = 'Check Out';
                                } else {
                                    // If it's some other string value, just use it directly
                                    badgeClass = 'bg-info';
                                    punchText = punchValue;
                                }
                            }
                            // Then check for numeric values
                            else if (punchValue === 0 || punchValue === '0') {
                                badgeClass = 'bg-success';
                                punchText = 'Check In';
                            } else if (punchValue === 1 || punchValue === '1') {
                                badgeClass = 'bg-danger';
                                punchText = 'Check Out';
                            } else if (punchValue === 2 || punchValue === '2') {
                                badgeClass = 'bg-warning';
                                punchText = 'Break Out';
                            } else if (punchValue === 3 || punchValue === '3') {
                                badgeClass = 'bg-info';
                                punchText = 'Break In';
                            } else if (punchValue === 4 || punchValue === '4') {
                                badgeClass = 'bg-primary';
                                punchText = 'Overtime In';
                            } else if (punchValue === 5 || punchValue === '5') {
                                badgeClass = 'bg-dark';
                                punchText = 'Overtime Out';
                            }
                            
                            console.log('Determined punch text:', punchText, 'with class:', badgeClass);
                            return { badgeClass, punchText };
                        }
                        
                        // Update punch types in the table based on the current records
                        sortedRecords.forEach((record, index) => {
                            const userId = record.id || record.emp_id || record.user_id;
                            if (userId) {
                                const rows = document.querySelectorAll(`#preview-table tr[data-user-id="${userId}"]`);
                                if (rows.length > 0) {
                                    rows.forEach(row => {
                                        const punchCell = row.querySelector('td:nth-child(4)');
                                        if (punchCell) {
                                            const { badgeClass, punchText } = determinePunchType(record);
                                            punchCell.innerHTML = `<span class="badge ${badgeClass}">${punchText}</span>`;
                                        }
                                    });
                                }
                            }
                        });
                        
                        // Display records
                        sortedRecords.forEach(record => {
                            const row = document.createElement('tr');
                            
                            // User ID - check for different possible property names
                            const userIdCell = document.createElement('td');
                            // This ZK device uses 'id' for user ID
                            const userId = record.id || record.emp_id || record.user_id || (typeof record === 'object' ? Object.values(record)[0] : 'N/A');
                            userIdCell.textContent = userId;
                            row.appendChild(userIdCell);
                            
                            // Store the user ID as a data attribute for later reference
                            row.setAttribute('data-user-id', userId);
                            
                            // Name - try to get from user map first, then fall back to record.name
                            const nameCell = document.createElement('td');
                            // If we have a user map and the user ID exists in it, use that name
                            if (window.userMap && window.userMap[userId]) {
                                nameCell.textContent = window.userMap[userId];
                            } else {
                                // Otherwise fall back to the name in the record or 'Unknown'
                                nameCell.textContent = record.name || 'Unknown';
                            }
                            row.appendChild(nameCell);
                            
                            // Date & Time with better formatting
                            const timeCell = document.createElement('td');
                            const time = new Date(record.timestamp);
                            // Format date as YYYY-MM-DD
                            const formattedDate = time.getFullYear() + '-' + 
                                String(time.getMonth() + 1).padStart(2, '0') + '-' + 
                                String(time.getDate()).padStart(2, '0');
                            timeCell.textContent = formattedDate;
                            row.appendChild(timeCell);
                            
                            // Punch Type
                            const typeCell = document.createElement('td');
                            
                            // Determine punch type directly from the record
                            const { badgeClass, punchText } = determinePunchType(record);
                            
                            // Show the raw punch value in the tooltip for debugging
                            const rawPunchValue = record.punch !== undefined ? record.punch : 
                                                  record.status !== undefined ? record.status : 
                                                  record.type !== undefined ? record.type : 
                                                  record.punch_type !== undefined ? record.punch_type : 'N/A';
                                                  
                            typeCell.innerHTML = `<span class="badge ${badgeClass}" title="Raw value: ${rawPunchValue}">${punchText}</span>`;
                            row.appendChild(typeCell);
                            
                            // Store the timestamp as a data attribute for debugging
                            if (record.timestamp) {
                                row.setAttribute('data-timestamp', record.timestamp);
                            }
                            
                            previewTable.appendChild(row);
                        });
                        
                        // Enable send button
                        sendToApiBtn.disabled = false;
                    } else {
                        // Show no records message
                        noRecords.classList.remove('d-none');
                        recordCount.textContent = '0 records';
                    }
                } catch (error) {
                    // Show error
                    previewLoading.classList.add('d-none');
                    noRecords.classList.remove('d-none');
                    noRecords.innerHTML = `
                        <i class="bi bi-exclamation-triangle text-danger fs-1"></i>
                        <p class="mt-2">Error loading attendance data: ${error.message}</p>
                        <button class="btn btn-sm btn-primary mt-2" onclick="location.reload()">
                            <i class="bi bi-arrow-clockwise"></i> Retry
                        </button>
                    `;
                }
            });
        }
        
        // Send data to API
        if (sendToApiBtn) {
            sendToApiBtn.addEventListener('click', async () => {
                // Show send status
                sendStatus.classList.remove('d-none');
                sendStatusContent.innerHTML = `
                    <div class="alert alert-info">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm me-2" role="status">
                                <span class="visually-hidden">Sending...</span>
                            </div>
                            <div>Sending ${currentRecords.length} records to API...</div>
                        </div>
                    </div>
                `;
                
                // Disable send button
                sendToApiBtn.disabled = true;
                
                try {
                    // Get date range
                    const startDate = document.getElementById('start_date').value;
                    const endDate = document.getElementById('end_date').value;
                    
                    // Send data to API
                    const response = await fetch('/api/send-attendance', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            start_date: startDate,
                            end_date: endDate
                        })
                    });
                    
                    const result = await response.json();
                    
                    // Show result
                    if (result.status === 'success') {
                        sendStatusContent.innerHTML = `
                            <div class="alert alert-success">
                                <h5><i class="bi bi-check-circle-fill me-2"></i> Success!</h5>
                                <p>تم إرسال ${result.sent_count || currentRecords.length} سجلات إلى SAS.</p>
                                <p class="mb-0"><strong>API Response:</strong> ${result.message || 'Data received successfully.'}</p>
                            </div>
                        `;
                    } else {
                        sendStatusContent.innerHTML = `
                            <div class="alert alert-danger">
                                <h5><i class="bi bi-x-circle-fill me-2"></i> Error!</h5>
                                <p>Failed to send data to API.</p>
                                <p class="mb-0"><strong>Error:</strong> ${result.message || 'Unknown error occurred.'}</p>
                            </div>
                        `;
                    }
                } catch (error) {
                    // Show error
                    sendStatusContent.innerHTML = `
                        <div class="alert alert-danger">
                            <h5><i class="bi bi-x-circle-fill me-2"></i> Error!</h5>
                            <p>Failed to send data to API.</p>
                            <p class="mb-0"><strong>Error:</strong> ${error.message}</p>
                        </div>
                    `;
                } finally {
                    // Re-enable send button
                    sendToApiBtn.disabled = false;
                }
            });
        }
    });
</script>
{% endblock %}
