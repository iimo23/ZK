{% extends "base.html" %}

{% block title %}Send Attendance Data - ZK Attendance System{% endblock %}

{% block content %}
{% if last_send_info %}
<div class="alert alert-info mb-4">
    <strong>Last Successful Send:</strong><br>
    <span><i class="bi bi-calendar-check"></i> {{ last_send_info.last_send_time|default('Not Available') }}</span><br>
    <span><i class="bi bi-info-circle"></i> {{ last_send_info.last_send_data.summary|default('Not Available') }}</span>
</div>
{% endif %}

<div class="row mb-4">
    <div class="col-12">
        <h1 class="h3 mb-0">Send Attendance Data</h1>
        <p class="text-muted">Send attendance records to your API</p>
    </div>
</div>


<!-- Device connection status will be checked via JavaScript -->
<div class="row mb-4" id="no-device-warning" style="display: none;">
    <div class="col-12">
        <div class="alert alert-warning shadow-sm">
            <div class="d-flex align-items-center">
                <div class="flex-shrink-0">
                    <i class="bi bi-exclamation-triangle-fill fs-3 me-3"></i>
                </div>
                <div class="flex-grow-1">
                    <h5 class="alert-heading">No Device Connected</h5>
                    <p class="mb-0">You need to connect to a device first before sending data.</p>
                </div>
                <div class="flex-shrink-0">
                    <a href="{{ url_for('connect') }}" class="btn btn-warning">
                        <i class="bi bi-plug"></i> Connect Device
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="date-range-form-container">
<div class="row">
    <div class="col-md-12">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Date Range Selection</h5>
            </div>
            <div class="card-body">
                <form id="date-range-form" class="row g-3">
                    <div class="col-md-5">
                        <label for="start_date" class="form-label">Start Date</label>
                        <input type="date" class="form-control" id="start_date" name="start_date" required>
                    </div>
                    <div class="col-md-5">
                        <label for="end_date" class="form-label">End Date</label>
                        <input type="date" class="form-control" id="end_date" name="end_date" required>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-search"></i> Preview
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Data Preview -->
        <div id="data-preview" class="card shadow-sm mb-4 d-none">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Data Preview</h5>
                <span id="record-count" class="badge bg-light text-dark">0 records</span>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>User ID</th>
                                <th>Name</th>
                                <th>Date & Time</th>
                                <th>Punch Type</th>
                            </tr>
                        </thead>
                        <tbody id="preview-table">
                            <!-- Preview data will be loaded here -->
                        </tbody>
                    </table>
                </div>
                
                <div id="preview-loading" class="text-center py-3 d-none">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading attendance data...</p>
                </div>
                
                <div id="no-records" class="text-center py-3 d-none">
                    <i class="bi bi-exclamation-circle text-warning fs-1"></i>
                    <p class="mt-2">No attendance records found for the selected date range.</p>
                </div>
                
                <div class="mt-3">
                    <button id="send-to-api" class="btn btn-success" disabled>
                        <i class="bi bi-cloud-upload"></i> Send to API
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Send Status -->
        <div id="send-status" class="card shadow-sm d-none">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Send Status</h5>
            </div>
            <div class="card-body" id="send-status-content">
                <!-- Send status will be shown here -->
            </div>
        </div>
    </div>
</div>
</div><!-- End of date-range-form-container -->
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Check if a device is connected using the device manager
        const checkDeviceConnection = async () => {
            try {
                const response = await fetch('/api/devices');
                const data = await response.json();
                
                if (data.status === 'success') {
                    // Check if there are any registered devices
                    if (Object.keys(data.devices).length === 0) {
                        document.getElementById('no-device-warning').style.display = 'block';
                        document.getElementById('date-range-form-container').style.display = 'none';
                        return false;
                    }
                    
                    // Check if there is an active device
                    if (!data.active_device) {
                        document.getElementById('no-device-warning').style.display = 'block';
                        document.getElementById('date-range-form-container').style.display = 'none';
                        return false;
                    }
                    
                    // Device is connected
                    document.getElementById('no-device-warning').style.display = 'none';
                    document.getElementById('date-range-form-container').style.display = 'block';
                    return true;
                } else {
                    // API error
                    document.getElementById('no-device-warning').style.display = 'block';
                    document.getElementById('date-range-form-container').style.display = 'none';
                    return false;
                }
            } catch (error) {
                console.error('Error checking device connection:', error);
                document.getElementById('no-device-warning').style.display = 'block';
                document.getElementById('date-range-form-container').style.display = 'none';
                return false;
            }
        };
        
        // Check device connection on page load
        checkDeviceConnection();
        
        const dateRangeForm = document.getElementById('date-range-form');
        const dataPreview = document.getElementById('data-preview');
        const previewTable = document.getElementById('preview-table');
        const previewLoading = document.getElementById('preview-loading');
        const noRecords = document.getElementById('no-records');
        const recordCount = document.getElementById('record-count');
        const sendToApiBtn = document.getElementById('send-to-api');
        const sendStatus = document.getElementById('send-status');
        const sendStatusContent = document.getElementById('send-status-content');
        
        // API URL Configuration Elements
        const currentApiUrl = document.getElementById('current-api-url');
        const editApiUrlBtn = document.getElementById('edit-api-url-btn');
        const apiUrlDisplay = document.getElementById('api-url-display');
        const apiUrlEdit = document.getElementById('api-url-edit');
        const apiUrlForm = document.getElementById('api-url-form');
        const apiUrlInput = document.getElementById('api_url');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const apiUrlStatus = document.getElementById('api-url-status');
        
        // Set default dates (today and yesterday)
        const today = new Date();
        const yesterday = new Date();
        yesterday.setDate(today.getDate() - 1);
        
        // Format dates as YYYY-MM-DD
        const formatDate = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        
        // Set default date values
        if (document.getElementById('start_date')) {
            document.getElementById('start_date').value = formatDate(yesterday);
        }
        
        if (document.getElementById('end_date')) {
            document.getElementById('end_date').value = formatDate(today);
        }
        
        // Store the current records
        let currentRecords = [];
        
        // Load current API URL
        const loadApiUrl = async () => {
            try {
                const response = await fetch('/api/export-config');
                const data = await response.json();
                
                if (data.status === 'success' && data.config) {
                    const apiUrl = data.config.attendance_api_url || '';
                    currentApiUrl.textContent = apiUrl || 'Not configured';
                    if (apiUrlInput) {
                        apiUrlInput.value = apiUrl;
                    }
                } else {
                    currentApiUrl.textContent = 'Error loading configuration';
                }
            } catch (error) {
                currentApiUrl.textContent = `Error: ${error.message}`;
            }
        };
        
        // Load API URL on page load
        loadApiUrl();
        
        // Handle edit button click
        if (editApiUrlBtn) {
            editApiUrlBtn.addEventListener('click', () => {
                apiUrlDisplay.classList.add('d-none');
                apiUrlEdit.classList.remove('d-none');
            });
        }
        
        // Handle cancel button click
        if (cancelEditBtn) {
            cancelEditBtn.addEventListener('click', () => {
                apiUrlDisplay.classList.remove('d-none');
                apiUrlEdit.classList.add('d-none');
                apiUrlStatus.classList.add('d-none');
            });
        }
        
        // Handle API URL form submission
        if (apiUrlForm) {
            apiUrlForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const apiUrl = apiUrlInput.value.trim();
                
                // Show loading status
                apiUrlStatus.innerHTML = `
                    <div class="alert alert-info">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm me-2" role="status">
                                <span class="visually-hidden">Saving...</span>
                            </div>
                            <div>Saving API URL configuration...</div>
                        </div>
                    </div>
                `;
                apiUrlStatus.classList.remove('d-none');
                
                try {
                    // Send API URL to server
                    const response = await fetch('/api/export-config', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            attendance_api_url: apiUrl
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        // Show success message
                        apiUrlStatus.innerHTML = `
                            <div class="alert alert-success">
                                <div class="d-flex align-items-center">
                                    <div class="me-2">
                                        <i class="bi bi-check-circle-fill"></i>
                                    </div>
                                    <div>
                                        <strong>Success!</strong><br>
                                        API URL has been updated in both configuration files.
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        // Update displayed URL
                        currentApiUrl.textContent = apiUrl;
                        
                        // Switch back to display mode after a delay
                        setTimeout(() => {
                            apiUrlDisplay.classList.remove('d-none');
                            apiUrlEdit.classList.add('d-none');
                            apiUrlStatus.classList.add('d-none');
                        }, 2000);
                    } else {
                        // Show error message
                        apiUrlStatus.innerHTML = `
                            <div class="alert alert-danger">
                                <div class="d-flex align-items-center">
                                    <div class="me-2">
                                        <i class="bi bi-exclamation-triangle-fill"></i>
                                    </div>
                                    <div>
                                        <strong>Error</strong><br>
                                        ${result.message || 'Failed to update API URL.'}
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                } catch (error) {
                    // Show error message
                    apiUrlStatus.innerHTML = `
                        <div class="alert alert-danger">
                            <div class="d-flex align-items-center">
                                <div class="me-2">
                                    <i class="bi bi-exclamation-triangle-fill"></i>
                                </div>
                                <div>
                                    <strong>Error</strong><br>
                                    ${error.message || 'An error occurred during the update.'}
                                </div>
                            </div>
                        </div>
                    `;
                }
            });
        }
        
        // Preview data based on date range
        if (dateRangeForm) {
            dateRangeForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                // Get date range
                const startDate = document.getElementById('start_date').value;
                const endDate = document.getElementById('end_date').value;
                
                // Show loading
                dataPreview.classList.remove('d-none');
                previewLoading.classList.remove('d-none');
                noRecords.classList.add('d-none');
                previewTable.innerHTML = '';
                sendToApiBtn.disabled = true;
                
                try {
                    // Fetch attendance data
                    const response = await fetch(`/api/attendance?start_date=${startDate}&end_date=${endDate}`);
                    const data = await response.json();
                    
                    // Hide loading
                    previewLoading.classList.add('d-none');
                    
                    if (data.status === 'success' && data.attendance && data.attendance.length > 0) {
                        // Store records
                        currentRecords = data.attendance;
                        
                        // Update record count
                        recordCount.textContent = `${currentRecords.length} records`;
                        
                        // Sort records by timestamp (newest first)
                        const sortedRecords = [...currentRecords].sort((a, b) => {
                            return new Date(b.timestamp) - new Date(a.timestamp);
                        });
                        
                        // Display records
                        sortedRecords.forEach(record => {
                            const row = document.createElement('tr');
                            
                            // User ID
                            const userIdCell = document.createElement('td');
                            userIdCell.textContent = record.user_id;
                            row.appendChild(userIdCell);
                            
                            // Name
                            const nameCell = document.createElement('td');
                            nameCell.textContent = record.name || 'Unknown';
                            row.appendChild(nameCell);
                            
                            // Date & Time
                            const timeCell = document.createElement('td');
                            const time = new Date(record.timestamp);
                            timeCell.textContent = time.toLocaleString();
                            row.appendChild(timeCell);
                            
                            // Punch Type
                            const typeCell = document.createElement('td');
                            const punchValue = record.punch;
                            let badgeClass = 'bg-secondary';
                            let punchText = 'Unknown';
                            
                            if (punchValue === 0 || punchValue === '0') {
                                badgeClass = 'bg-success';
                                punchText = 'Check In';
                            } else if (punchValue === 1 || punchValue === '1') {
                                badgeClass = 'bg-danger';
                                punchText = 'Check Out';
                            }
                            
                            typeCell.innerHTML = `<span class="badge ${badgeClass}">${punchText}</span>`;
                            row.appendChild(typeCell);
                            
                            previewTable.appendChild(row);
                        });
                        
                        // Enable send button
                        sendToApiBtn.disabled = false;
                    } else {
                        // Show no records message
                        noRecords.classList.remove('d-none');
                        recordCount.textContent = '0 records';
                    }
                } catch (error) {
                    // Show error
                    previewLoading.classList.add('d-none');
                    noRecords.classList.remove('d-none');
                    noRecords.innerHTML = `
                        <i class="bi bi-exclamation-triangle text-danger fs-1"></i>
                        <p class="mt-2">Error loading attendance data: ${error.message}</p>
                        <button class="btn btn-sm btn-primary mt-2" onclick="location.reload()">
                            <i class="bi bi-arrow-clockwise"></i> Retry
                        </button>
                    `;
                }
            });
        }
        
        // Send data to API
        if (sendToApiBtn) {
            sendToApiBtn.addEventListener('click', async () => {
                // Show send status
                sendStatus.classList.remove('d-none');
                sendStatusContent.innerHTML = `
                    <div class="alert alert-info">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm me-2" role="status">
                                <span class="visually-hidden">Sending...</span>
                            </div>
                            <div>Sending ${currentRecords.length} records to API...</div>
                        </div>
                    </div>
                `;
                
                // Disable send button
                sendToApiBtn.disabled = true;
                
                try {
                    // Get date range
                    const startDate = document.getElementById('start_date').value;
                    const endDate = document.getElementById('end_date').value;
                    
                    // Send data to API
                    const response = await fetch('/api/send-attendance', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            start_date: startDate,
                            end_date: endDate
                        })
                    });
                    
                    const result = await response.json();
                    
                    // Show result
                    if (result.status === 'success') {
                        sendStatusContent.innerHTML = `
                            <div class="alert alert-success">
                                <h5><i class="bi bi-check-circle-fill me-2"></i> Success!</h5>
                                <p>Successfully sent ${result.sent_count || currentRecords.length} records to API.</p>
                                <p class="mb-0"><strong>API Response:</strong> ${result.message || 'Data received successfully.'}</p>
                            </div>
                        `;
                    } else {
                        sendStatusContent.innerHTML = `
                            <div class="alert alert-danger">
                                <h5><i class="bi bi-x-circle-fill me-2"></i> Error!</h5>
                                <p>Failed to send data to API.</p>
                                <p class="mb-0"><strong>Error:</strong> ${result.message || 'Unknown error occurred.'}</p>
                            </div>
                        `;
                    }
                } catch (error) {
                    // Show error
                    sendStatusContent.innerHTML = `
                        <div class="alert alert-danger">
                            <h5><i class="bi bi-x-circle-fill me-2"></i> Error!</h5>
                            <p>Failed to send data to API.</p>
                            <p class="mb-0"><strong>Error:</strong> ${error.message}</p>
                        </div>
                    `;
                } finally {
                    // Re-enable send button
                    sendToApiBtn.disabled = false;
                }
            });
        }
    });
</script>
{% endblock %}
